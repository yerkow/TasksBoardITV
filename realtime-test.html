<!DOCTYPE html>
<html>
<head>
    <title>Real-time Task Updates Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .log { background-color: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #logs { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîÑ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–¥–∞—á –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
    
    <div class="info">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ: <a href="https://localhost:8080" target="_blank">https://localhost:8080</a></li>
            <li>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</li>
            <li>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –∏ –Ω–∞–∑–Ω–∞—á—å—Ç–µ –µ—ë –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</li>
            <li>–ù–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –Ω–∏–∂–µ - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è WebSocket —Å–æ–±—ã—Ç–∏—è</li>
        </ol>
    </div>
    
    <div id="connection-status" class="status error">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
    
    <div>
        <button onclick="testConnection()">üîå –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
        <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>
    
    <h3>üìã –õ–æ–≥–∏ WebSocket —Å–æ–±—ã—Ç–∏–π:</h3>
    <div id="logs"></div>
    
    <script>
        let socket = null;
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('connection-status');
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log';
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, isConnected) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${isConnected ? 'success' : 'error'}`;
        }
        
        function testConnection() {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                addLog('‚ùå –¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
                addLog('üí° –û—Ç–∫—Ä–æ–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }
            
            addLog('üîë –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: ' + token.substring(0, 20) + '...');
            
            if (socket) {
                socket.disconnect();
            }
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ HTTPS —Å–µ—Ä–≤–µ—Ä—É
            socket = io('https://localhost:3002', {
                transports: ['websocket', 'polling'],
                timeout: 20000,
                rejectUnauthorized: false // –î–ª—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
            });
            
            socket.on('connect', () => {
                addLog('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω: ' + socket.id);
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω', true);
                
                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                socket.emit('authenticate', token);
                addLog('üîê –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            });
            
            socket.on('authenticated', (data) => {
                addLog('‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ' + JSON.stringify(data));
            });
            
            socket.on('authentication_error', (error) => {
                addLog('‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + JSON.stringify(error));
            });
            
            socket.on('disconnect', (reason) => {
                addLog('üîå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω: ' + reason);
                updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω', false);
            });
            
            socket.on('connect_error', (error) => {
                addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', false);
            });
            
            // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∑–∞–¥–∞—á
            socket.on('task_created_global', (task) => {
                addLog('üéâ –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ): ' + task.title + ' (ID: ' + task.id + ')');
                addLog('üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–∞: ' + (task.assigneeName || '–ù–µ —É–∫–∞–∑–∞–Ω'));
            });
            
            socket.on('task_updated_global', (task) => {
                addLog('üìù –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ): ' + task.title + ' ‚Üí ' + task.status);
            });
            
            socket.on('task_created', (task) => {
                addLog('üìù –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è): ' + task.title);
            });
            
            socket.on('task_updated', (task) => {
                addLog('üìù –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è): ' + task.title + ' ‚Üí ' + task.status);
            });
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç...');
            testConnection();
        };
    </script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html>